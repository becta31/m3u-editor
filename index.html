<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U/M3U8 —Ä–µ–¥–∞–∫—Ç–æ—Ä (—Ç–µ–ª–µ—Ñ–æ–Ω)</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--text:#e8eeff;--muted:#93a3c8;--line:rgba(255,255,255,.12);
      --accent:#6ea8fe;--danger:#ff6b6b;--ok:#55efc4}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#070a14,var(--bg));color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.9);backdrop-filter:blur(10px);
      padding:12px 14px;border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:16px}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .card{background:rgba(18,26,51,.93);border:1px solid var(--line);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea, select{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);outline:none
    }
    textarea{min-height:78px;resize:vertical}
    .btn{border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:rgba(110,168,254,.18);border-color:rgba(110,168,254,.35)}
    .btn.ok{background:rgba(85,239,196,.12);border-color:rgba(85,239,196,.35)}
    .btn.danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.35)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .pill{font-size:12px;color:var(--muted);padding:4px 8px;border:1px solid var(--line);border-radius:999px}

    /* list */
    .item{padding:10px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.10);margin-bottom:10px}
    .item.selected{outline:2px solid rgba(110,168,254,.35);background:rgba(110,168,254,.06)}
    .title{font-weight:700}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center}
    .mini .btn{padding:8px 10px;border-radius:10px}
    .moveBtns{display:flex;gap:8px;margin-left:auto}

    /* selection */
    .checkWrap{display:flex;align-items:center;gap:10px}
    .checkbox{
      width:24px;height:24px; accent-color: var(--accent);
      transform: translateY(1px);
    }

    /* bottom sheet for clean mode controls */
    .sheetBtn{margin-left:auto}
    .sheet{
      position:fixed;left:0;right:0;bottom:-100%;
      background:rgba(18,26,51,.98);
      border-top:1px solid var(--line);
      padding:12px;
      transition:bottom .18s ease;
      z-index:50;
      max-height:70vh;
      overflow:auto;
    }
    .sheet.open{bottom:0}
    .sheetHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sheetTitle{font-weight:700}
    .chipRow{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .chip.on{border-color:rgba(110,168,254,.55);background:rgba(110,168,254,.12)}
    .bar{
      position:fixed;left:0;right:0;bottom:0;z-index:60;
      background:rgba(11,16,32,.92);backdrop-filter:blur(10px);
      border-top:1px solid var(--line);
      padding:10px 12px;
      display:none;
    }
    .bar.on{display:block}
    .bar .row{justify-content:space-between}
    .bar .btn{padding:10px 10px;border-radius:12px}
    .count{font-size:12px;color:var(--muted)}

    /* --- Layout: groups sidebar + list --- */
    .layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .layout{ grid-template-columns: 1fr; }
    }

    .sidebar{
      position:sticky;
      top:64px;
      max-height: calc(100vh - 80px);
      overflow:auto;
    }
    @media (max-width: 860px){
      .sidebar{ position:static; max-height:none; display:none; }
      .sidebar.open{ display:block; }
    }

    .groupList{ display:flex; flex-direction:column; gap:8px; }
    .groupItem{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.10);
      cursor:pointer;
    }
    .groupItem.active{
      border-color: rgba(110,168,254,.55);
      background: rgba(110,168,254,.10);
    }
    .groupName{ font-size:14px; font-weight:600; }
    .groupCount{
      font-size:12px; color:var(--muted);
      padding:2px 8px; border:1px solid var(--line);
      border-radius:999px;
    }

    .sideToggleRow{ display:none; }
    @media (max-width: 860px){
      .sideToggleRow{ display:flex; gap:10px; align-items:center; }
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <h1>M3U/M3U8 —Ä–µ–¥–∞–∫—Ç–æ—Ä (—Ç–µ–ª–µ—Ñ–æ–Ω)</h1>
    <span class="pill" id="countPill">0</span>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="row">
      <input id="fileInput" type="file" accept=".m3u,.m3u8,text/plain" />
      <button class="btn primary" id="btnNew">–ù–æ–≤—ã–π</button>
    </div>
    <div class="hint" id="fileInfo" style="margin-top:8px">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>

    <div class="sep"></div>

    <div class="row">
      <button class="btn ok" id="btnAdd">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn danger" id="btnDeleteOne" disabled>–£–¥–∞–ª–∏—Ç—å 1</button>
      <button class="btn primary" id="btnDownload" disabled>–°–∫–∞—á–∞—Ç—å .m3u8</button>
      <button class="btn" id="btnCleanMode" style="margin-left:auto">üßπ –†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏: –≤—ã–∫–ª</button>
    </div>

    <div class="sep"></div>

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>–ü–æ–∏—Å–∫</label>
        <input id="search" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ / –≥—Ä—É–ø–ø–∞ / url" />
      </div>
      <div style="flex:1;min-width:220px">
        <label>–ì—Ä—É–ø–ø–∞</label>
        <select id="groupFilter"><option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option></select>
      </div>
    </div>

    <div class="hint" style="margin-top:10px">
      –ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤–∫–ª—é—á–∏ <b>–†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏</b> ‚Üí –ø–æ—è–≤—è—Ç—Å—è –≥–∞–ª–æ—á–∫–∏, —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∏ –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ.
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- layout: sidebar + list -->
  <div class="layout">

    <!-- LEFT: groups -->
    <div class="card sidebar" id="sidebar">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="hint"><b>–ì—Ä—É–ø–ø—ã</b></div>
        <span class="pill" id="groupsInfo">0</span>
      </div>
      <div style="height:10px"></div>
      <div id="groupList" class="groupList"></div>
      <div class="hint" style="margin-top:10px">
        –¢–∞–ø –ø–æ –≥—Ä—É–ø–ø–µ = —Ñ–∏–ª—å—Ç—Ä. ‚Äú–í—Å–µ‚Äù –ø–æ–∫–∞–∂–µ—Ç –≤–µ—Å—å –ø–ª–µ–π–ª–∏—Å—Ç.
      </div>
    </div>

    <!-- RIGHT: list -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div class="hint"><b>–°–ø–∏—Å–æ–∫</b> (—Ç–∞–ø–Ω–∏ ‚Äú–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å‚Äù)</div>

        <div class="sideToggleRow">
          <button class="btn" id="btnToggleGroups">–ì—Ä—É–ø–ø—ã</button>
        </div>

        <div class="hint" id="viewInfo"></div>
      </div>
      <div style="height:8px"></div>
      <div id="list"></div>
      <div class="hint" id="status"></div>
    </div>

  </div>

  <div style="height:12px"></div>

  <div class="card" id="editorCard">
    <div class="hint" style="margin-bottom:10px"><b>–†–µ–¥–∞–∫—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ</b></div>

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="fName" />
      </div>
      <div style="flex:1;min-width:220px">
        <label>–ì—Ä—É–ø–ø–∞ (group-title)</label>
        <input id="fGroup" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:220px">
        <label>tvg-id</label>
        <input id="fTvgId" />
      </div>
      <div style="flex:1;min-width:220px">
        <label>tvg-name</label>
        <input id="fTvgName" />
      </div>
      <div style="flex:1;min-width:220px">
        <label>tvg-logo</label>
        <input id="fTvgLogo" />
      </div>
    </div>

    <div style="margin-top:10px">
      <label>URL</label>
      <textarea id="fUrl"></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnApply" disabled>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      <button class="btn" id="btnRevert" disabled>–û—Ç–∫–∞—Ç–∏—Ç—å</button>
    </div>

    <div class="sep"></div>
    <div class="hint">
      –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞: –∫–Ω–æ–ø–∫–∏ ‚Üë/‚Üì —É –∑–∞–ø–∏—Å–∏. –í —Ä–µ–∂–∏–º–µ —á–∏—Å—Ç–∫–∏ ‚Äî –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º/–∫—Ä–∏—Ç–µ—Ä–∏—è–º.
    </div>
  </div>

</div>

<!-- Bottom sheet: Clean mode controls -->
<div class="sheet" id="sheet">
  <div class="sheetHeader">
    <div class="sheetTitle">üßπ –†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏</div>
    <button class="btn" id="btnCloseSheet">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div class="sep"></div>

  <div class="hint"><b>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ç–±–æ—Ä–∞</b> (—Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ —Å ‚Äú–ü–æ–∏—Å–∫‚Äù –∏ ‚Äú–ì—Ä—É–ø–ø–∞‚Äù)</div>
  <div style="height:8px"></div>

  <div class="hint" style="margin-bottom:6px">–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</div>
  <div class="chipRow" id="qChips">
    <div class="chip" data-q="UHD">UHD / 4K</div>
    <div class="chip" data-q="FHD">FHD / 1080</div>
    <div class="chip" data-q="HD">HD / 720</div>
    <div class="chip" data-q="SD">SD</div>
  </div>

  <div style="height:10px"></div>
  <div class="hint" style="margin-bottom:6px">–ü–æ–ª—è</div>
  <div class="chipRow" id="fieldChips">
    <div class="chip" data-f="noGroup">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</div>
    <div class="chip" data-f="noTvgId">–ü—É—Å—Ç–æ–π tvg-id</div>
    <div class="chip" data-f="noLogo">–ü—É—Å—Ç–æ–π tvg-logo</div>
  </div>

  <div style="height:10px"></div>
  <div class="hint" style="margin-bottom:6px">–°–ª–æ–≤–∞-–º—É—Å–æ—Ä (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)</div>
  <div class="chipRow" id="junkChips">
    <div class="chip" data-j="test">test</div>
    <div class="chip" data-j="backup">backup</div>
    <div class="chip" data-j="promo">promo</div>
  </div>

  <div class="sep"></div>

  <div class="hint"><b>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</b> (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–º—É —Å–ø–∏—Å–∫—É)</div>
  <div style="height:8px"></div>
  <div class="row">
    <select id="sortMode" style="flex:1;min-width:220px">
      <option value="none">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
      <option value="quality">–ü–æ –∫–∞—á–µ—Å—Ç–≤—É (UHD‚ÜíFHD‚ÜíHD‚ÜíSD)</option>
      <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (A‚ÜíZ)</option>
      <option value="group_name">–ü–æ –≥—Ä—É–ø–ø–µ ‚Üí –Ω–∞–∑–≤–∞–Ω–∏—é</option>
    </select>
    <button class="btn primary" id="btnApplySort">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É</button>
  </div>

  <div class="sep"></div>
  <div class="row">
    <button class="btn" id="btnClearClean">–°–±—Ä–æ—Å–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏</button>
  </div>

  <div class="hint" style="margin-top:10px">
    –í–∞–∂–Ω–æ: ‚Äú–í—ã–±—Ä–∞—Ç—å –≤—Å–µ‚Äù –∏ ‚Äú–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ‚Äù –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è <b>—Ç–æ–ª—å–∫–æ</b> –∫ —Ç–µ–∫—É—â–µ–º—É –æ—Ç–æ–±—Ä–∞–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É.
  </div>
</div>

<!-- Bottom bar: bulk actions -->
<div class="bar" id="bar">
  <div class="row">
    <div>
      <div class="count" id="selInfo">–í—ã–±—Ä–∞–Ω–æ: 0</div>
      <div class="count" id="viewCountInfo"></div>
    </div>
    <div class="row" style="gap:8px">
      <button class="btn" id="btnSelectAll">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
      <button class="btn" id="btnClearSel">–°–Ω—è—Ç—å</button>
      <button class="btn danger" id="btnBulkDelete" disabled>–£–¥–∞–ª–∏—Ç—å (0)</button>
    </div>
  </div>
</div>

<script>
(() => {
  let entries = [];
  let selectedId = null;
  let loadedFileName = null;

  // Clean mode state
  let cleanMode = false;
  const clean = {
    q: new Set(),       // UHD, FHD, HD, SD
    fields: new Set(),  // noGroup, noTvgId, noLogo
    junk: new Set(),    // test, backup, promo
    sort: "none"
  };

  // Multi-select state (ids of entries)
  const selectedSet = new Set();
  let lastDeletedSnapshot = null; // simple undo could be added later

  const $ = (id) => document.getElementById(id);
  const els = {
    fileInput: $("fileInput"),
    fileInfo: $("fileInfo"),
    list: $("list"),
    status: $("status"),
    countPill: $("countPill"),
    viewInfo: $("viewInfo"),
    search: $("search"),
    groupFilter: $("groupFilter"),
    btnNew: $("btnNew"),
    btnAdd: $("btnAdd"),
    btnDeleteOne: $("btnDeleteOne"),
    btnDownload: $("btnDownload"),
    btnCleanMode: $("btnCleanMode"),

    editorCard: $("editorCard"),
    btnApply: $("btnApply"),
    btnRevert: $("btnRevert"),
    fName: $("fName"),
    fGroup: $("fGroup"),
    fTvgId: $("fTvgId"),
    fTvgName: $("fTvgName"),
    fTvgLogo: $("fTvgLogo"),
    fUrl: $("fUrl"),

    sheet: $("sheet"),
    btnCloseSheet: $("btnCloseSheet"),
    qChips: $("qChips"),
    fieldChips: $("fieldChips"),
    junkChips: $("junkChips"),
    sortMode: $("sortMode"),
    btnApplySort: $("btnApplySort"),
    btnClearClean: $("btnClearClean"),

    bar: $("bar"),
    selInfo: $("selInfo"),
    viewCountInfo: $("viewCountInfo"),
    btnSelectAll: $("btnSelectAll"),
    btnClearSel: $("btnClearSel"),
    btnBulkDelete: $("btnBulkDelete"),

    // sidebar groups
    sidebar: $("sidebar"),
    groupList: $("groupList"),
    groupsInfo: $("groupsInfo"),
    btnToggleGroups: $("btnToggleGroups"),
  };

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function setStatus(msg){ els.status.textContent = msg || ""; }
  function escapeHtml(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function escapeAttr(v){ return String(v ?? "").replaceAll('"','\\"'); }

  function parseExtinfAttrs(extinfLine){
    const attrs = {};
    const preComma = extinfLine.split(",")[0] || "";
    const parts = preComma.replace(/^#EXTINF:/i, "");
    const attrRe = /([\w-]+)\s*=\s*"([^"]*)"/g;
    let m; while((m = attrRe.exec(parts)) !== null){ attrs[m[1]] = m[2]; }
    return attrs;
  }
  function parseExtinfName(extinfLine){
    const idx = extinfLine.indexOf(",");
    return idx === -1 ? "" : extinfLine.slice(idx+1).trim();
  }

  // FIXED parser: supports #EXTGRP between EXTINF and URL
  function parseM3U(text){
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
    const out = [];
    let i = 0;

    const isSkippableMetaBetween = (s) => (
      s.startsWith("#EXTVLCOPT") ||
      s.startsWith("#KODIPROP") ||
      s.startsWith("#EXT-X-") ||
      s.startsWith("#EXTHTTP") ||
      s.startsWith("#EXTIMG") ||
      s.startsWith("#EXTALB") ||
      s.startsWith("#EXTART")
    );

    while(i < lines.length){
      let line = (lines[i] ?? "").trim();
      if(!line){ i++; continue; }

      if(line.startsWith("#EXTM3U")) { i++; continue; }
      if(line.startsWith("#EXTGRP")) { i++; continue; }

      if(line.startsWith("#EXTINF")){
        const extinf = line;
        const dur = (extinf.match(/^#EXTINF:\s*([-\d]+)/i)?.[1]) || "-1";
        const attrs = parseExtinfAttrs(extinf);
        const name = parseExtinfName(extinf) || (attrs["tvg-name"] || "");

        i++;

        while(i < lines.length && !(lines[i] ?? "").trim()) i++;

        if(i < lines.length){
          const maybeGrp = (lines[i] ?? "").trim();
          if(maybeGrp.startsWith("#EXTGRP")){
            const grp = maybeGrp.split(":").slice(1).join(":").trim();
            if(grp) attrs["group-title"] = grp;
            i++;
            while(i < lines.length && !(lines[i] ?? "").trim()) i++;
          }
        }

        while(i < lines.length){
          const maybe = (lines[i] ?? "").trim();
          if(!maybe){ i++; continue; }
          if(maybe.startsWith("#") && isSkippableMetaBetween(maybe)) { i++; continue; }
          break;
        }

        const urlLine = i < lines.length ? (lines[i] ?? "").trim() : "";
        const url = (urlLine && !urlLine.startsWith("#")) ? urlLine : "";

        out.push({ id: uid(), name, url, dur, attrs });
        i++;
        continue;
      }

      if(!line.startsWith("#")){
        out.push({ id: uid(), name: line, url: line, dur:"-1", attrs:{} });
        i++;
        continue;
      }

      i++;
    }

    return out;
  }

  // FIXED exporter: never outputs entries without URL, no #EXTGRP, standard -1
  function toM3U8(list){
    const lines = ["#EXTM3U"];
    for(const e of list){
      const url = (e.url ?? "").toString().trim();
      if(!url || url.startsWith("#")) continue;

      const attrs = e.attrs || {};
      const dur = "-1";

      let attrStr = "";
      for(const k of Object.keys(attrs)){
        const val = attrs[k];
        if(val === undefined || val === null || val === "") continue;
        attrStr += ` ${k}="${escapeAttr(val)}"`;
      }

      const name = (e.name ?? "").toString().trim();
      lines.push(`#EXTINF:${dur}${attrStr},${name}`);
      lines.push(url);
    }
    return lines.join("\n") + "\n";
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"application/x-mpegURL;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function updateCount(){
    els.countPill.textContent = `${entries.length} –∑–∞–ø–∏—Å–µ–π`;
    const can = entries.length > 0;
    els.btnDownload.disabled = !can;
  }

  function rebuildGroupFilter(){
    const current = els.groupFilter.value;
    const groups = Array.from(new Set(entries.map(e => (e.attrs?.["group-title"]||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b, "ru"));

    const hasNoGroup = entries.some(e => !((e.attrs?.["group-title"]||"").trim()));
    const noGroupOpt = hasNoGroup ? `<option value="__NO_GROUP__">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</option>` : "";

    els.groupFilter.innerHTML =
      `<option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>` +
      noGroupOpt +
      groups.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("");

    if(current === "__NO_GROUP__" && hasNoGroup){
      els.groupFilter.value = "__NO_GROUP__";
      return;
    }
    if(groups.includes(current)) els.groupFilter.value = current;
  }

  function renderGroupSidebar(){
    const counts = new Map();
    let noGroup = 0;

    for(const e of entries){
      const g = (e.attrs?.["group-title"] || "").trim();
      if(!g) { noGroup++; continue; }
      counts.set(g, (counts.get(g) || 0) + 1);
    }

    const groups = [...counts.keys()].sort((a,b)=>a.localeCompare(b, "ru"));
    const totalGroups = groups.length + (noGroup > 0 ? 1 : 0);
    els.groupsInfo.textContent = `${totalGroups}`;

    const current = els.groupFilter.value;
    let html = "";

    html += `
      <div class="groupItem ${current==="" ? "active":""}" data-group="">
        <div class="groupName">–í—Å–µ</div>
        <div class="groupCount">${entries.length}</div>
      </div>
    `;

    if(noGroup > 0){
      html += `
        <div class="groupItem ${current==="__NO_GROUP__" ? "active":""}" data-group="__NO_GROUP__">
          <div class="groupName">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</div>
          <div class="groupCount">${noGroup}</div>
        </div>
      `;
    }

    for(const g of groups){
      const c = counts.get(g);
      html += `
        <div class="groupItem ${current===g ? "active":""}" data-group="${escapeHtml(g)}">
          <div class="groupName">${escapeHtml(g)}</div>
          <div class="groupCount">${c}</div>
        </div>
      `;
    }

    els.groupList.innerHTML = html;

    els.groupList.querySelectorAll(".groupItem").forEach(item=>{
      item.addEventListener("click", ()=>{
        const g = item.getAttribute("data-group") || "";
        els.groupFilter.value = g;

        if(window.matchMedia("(max-width: 860px)").matches){
          els.sidebar.classList.remove("open");
        }
        render();
      });
    });
  }

  function qualityRank(name){
    const t = (name||"").toLowerCase();
    const has = (re) => re.test(t);
    if(has(/\b(uhd|4k)\b/)) return 4;
    if(has(/\b(fhd|1080p|1080)\b/)) return 3;
    if(has(/\b(hd|720p|720)\b/)) return 2;
    if(has(/\b(sd|480p|480)\b/)) return 1;
    return 0;
  }

  function matchesCleanCriteria(e){
    const name = (e.name||"").toLowerCase();
    const group = ((e.attrs?.["group-title"]||"").trim());
    const tvgId = ((e.attrs?.["tvg-id"]||"").trim());
    const logo = ((e.attrs?.["tvg-logo"]||"").trim());

    if(clean.q.size){
      const r = qualityRank(e.name);
      let ok = false;
      if(clean.q.has("UHD") && r === 4) ok = true;
      if(clean.q.has("FHD") && r === 3) ok = true;
      if(clean.q.has("HD")  && r === 2) ok = true;
      if(clean.q.has("SD")  && r === 1) ok = true;
      if(!ok) return false;
    }

    if(clean.fields.has("noGroup") && group) return false;
    if(clean.fields.has("noTvgId") && tvgId) return false;
    if(clean.fields.has("noLogo")  && logo) return false;

    if(clean.junk.size){
      let ok = false;
      for(const j of clean.junk){
        if(name.includes(j)) { ok = true; break; }
      }
      if(!ok) return false;
    }

    return true;
  }

  function filteredBase(){
    const q = els.search.value.trim().toLowerCase();
    const g = els.groupFilter.value;

    return entries.filter(e=>{
      const group = (e.attrs?.["group-title"]||"").trim();
      const hay = `${e.name}\n${group}\n${e.url}`.toLowerCase();

      if(g){
        if(g === "__NO_GROUP__"){
          if(group) return false;
        } else {
          if(group !== g) return false;
        }
      }
      if(q && !hay.includes(q)) return false;
      return true;
    });
  }

  function viewEntries(){
    let view = filteredBase();

    if(cleanMode){
      view = view.filter(matchesCleanCriteria);

      if(clean.sort === "quality"){
        view = [...view].sort((a,b)=>{
          const ra = qualityRank(a.name), rb = qualityRank(b.name);
          if(ra !== rb) return rb - ra;
          const ga = (a.attrs?.["group-title"]||"").toLowerCase();
          const gb = (b.attrs?.["group-title"]||"").toLowerCase();
          if(ga !== gb) return ga.localeCompare(gb);
          return (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"});
        });
      } else if(clean.sort === "name"){
        view = [...view].sort((a,b)=> (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"}));
      } else if(clean.sort === "group_name"){
        view = [...view].sort((a,b)=>{
          const ga = (a.attrs?.["group-title"]||"").toLowerCase();
          const gb = (b.attrs?.["group-title"]||"").toLowerCase();
          if(ga !== gb) return ga.localeCompare(gb);
          return (a.name||"").localeCompare(b.name||"", undefined, {sensitivity:"base"});
        });
      }
    }

    return view;
  }

  function syncBar(view){
    if(!cleanMode){
      els.bar.classList.remove("on");
      return;
    }
    els.bar.classList.add("on");
    const sel = selectedSet.size;
    els.selInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${sel}`;
    els.viewCountInfo.textContent = `–ù–∞ —ç–∫—Ä–∞–Ω–µ: ${view.length}`;
    els.btnBulkDelete.disabled = sel === 0;
    els.btnBulkDelete.textContent = `–£–¥–∞–ª–∏—Ç—å (${sel})`;
  }

  function render(){
    rebuildGroupFilter();
    renderGroupSidebar();
    updateCount();

    const view = viewEntries();

    els.viewInfo.textContent = cleanMode
      ? `–û—Ç–æ–±—Ä–∞–Ω–æ: ${view.length}`
      : `–ü–æ–∫–∞–∑–∞–Ω–æ: ${view.length}`;

    els.list.innerHTML = "";
    if(view.length === 0){
      els.list.innerHTML = `<div class="hint">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
      setStatus("");
      syncBar(view);
      return;
    }

    for(const e of view){
      const group = (e.attrs?.["group-title"]||"").trim();
      const urlShort = (e.url||"").replace(/^https?:\/\//,"").slice(0,60);
      const isSelectedOne = (e.id===selectedId);
      const isChecked = selectedSet.has(e.id);

      const div = document.createElement("div");
      div.className = "item" + (isSelectedOne ? " selected" : "");

      const left = cleanMode
        ? `<input class="checkbox" type="checkbox" ${isChecked ? "checked":""} aria-label="select">`
        : "";

      div.innerHTML = `
        <div class="checkWrap">
          ${left}
          <div style="flex:1">
            <div class="title">${escapeHtml(e.name || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)")}</div>
            <div class="sub">${escapeHtml(group || "–ë–µ–∑ –≥—Ä—É–ø–ø—ã")} ‚Ä¢ ${escapeHtml(urlShort)}</div>
          </div>
        </div>
        <div class="mini">
          <button class="btn" data-act="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <div class="moveBtns">
            <button class="btn" data-act="up">‚Üë</button>
            <button class="btn" data-act="down">‚Üì</button>
          </div>
        </div>
      `;

      if(cleanMode){
        const cb = div.querySelector('input[type="checkbox"]');
        cb.addEventListener("click", (ev)=>{
          ev.stopPropagation();
          if(cb.checked) selectedSet.add(e.id);
          else selectedSet.delete(e.id);
          syncBar(view);
        });

        div.querySelector(".checkWrap").addEventListener("click", (ev)=>{
          if(ev.target?.tagName?.toLowerCase() === "button") return;
          if(ev.target?.tagName?.toLowerCase() === "input") return;
          cb.checked = !cb.checked;
          if(cb.checked) selectedSet.add(e.id);
          else selectedSet.delete(e.id);
          syncBar(view);
        });
      }

      div.querySelector('[data-act="edit"]').onclick = () => select(e.id);
      div.querySelector('[data-act="up"]').onclick = (ev) => { ev.stopPropagation(); move(e.id, -1); };
      div.querySelector('[data-act="down"]').onclick = (ev) => { ev.stopPropagation(); move(e.id, +1); };

      els.list.appendChild(div);
    }

    setStatus(cleanMode ? `–†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏: –≤–∫–ª—é—á—ë–Ω` : "");
    syncBar(view);
  }

  function clearEditor(){
    selectedId = null;
    els.fName.value=""; els.fGroup.value=""; els.fTvgId.value=""; els.fTvgName.value=""; els.fTvgLogo.value=""; els.fUrl.value="";
    els.btnDeleteOne.disabled = true;
    els.btnApply.disabled = true;
    els.btnRevert.disabled = true;
  }

  function select(id){
    selectedId = id;
    const e = entries.find(x=>x.id===id);
    if(!e){ clearEditor(); render(); return; }

    els.fName.value = e.name || "";
    els.fGroup.value = e.attrs?.["group-title"] || "";
    els.fTvgId.value = e.attrs?.["tvg-id"] || "";
    els.fTvgName.value = e.attrs?.["tvg-name"] || "";
    els.fTvgLogo.value = e.attrs?.["tvg-logo"] || "";
    els.fUrl.value = e.url || "";

    els.btnDeleteOne.disabled = false;
    els.btnApply.disabled = false;
    els.btnRevert.disabled = false;
    render();
  }

  function apply(){
    const e = entries.find(x=>x.id===selectedId);
    if(!e) return;
    e.name = els.fName.value.trim();
    e.url = els.fUrl.value.trim();
    e.attrs = e.attrs || {};

    const group = els.fGroup.value.trim();
    if(group) e.attrs["group-title"] = group; else delete e.attrs["group-title"];

    const tvgId = els.fTvgId.value.trim();
    if(tvgId) e.attrs["tvg-id"] = tvgId; else delete e.attrs["tvg-id"];

    const tvgName = els.fTvgName.value.trim();
    if(tvgName) e.attrs["tvg-name"] = tvgName; else delete e.attrs["tvg-name"];

    const tvgLogo = els.fTvgLogo.value.trim();
    if(tvgLogo) e.attrs["tvg-logo"] = tvgLogo; else delete e.attrs["tvg-logo"];

    render();
  }

  function revert(){ if(selectedId) select(selectedId); }

  function add(){
    const e = { id: uid(), name:"", url:"", dur:"-1", attrs:{} };
    entries.unshift(e);
    select(e.id);
    render();
  }

  function delOne(){
    if(!selectedId) return;
    const idx = entries.findIndex(x=>x.id===selectedId);
    if(idx>=0) entries.splice(idx,1);
    selectedSet.delete(selectedId);
    clearEditor();
    render();
  }

  function move(id, dir){
    const idx = entries.findIndex(x=>x.id===id);
    if(idx<0) return;
    const j = idx + dir;
    if(j<0 || j>=entries.length) return;
    const tmp = entries[idx];
    entries[idx] = entries[j];
    entries[j] = tmp;
    render();
  }

  async function loadFile(file){
    const text = await file.text();
    entries = parseM3U(text);
    loadedFileName = file.name || "playlist.m3u8";
    els.fileInfo.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${loadedFileName} ‚Ä¢ ${entries.length} –∑–∞–ø–∏—Å–µ–π`;
    selectedSet.clear();
    clearEditor();
    render();
  }

  function newPlaylist(){
    entries = [];
    loadedFileName = "playlist.m3u8";
    els.fileInfo.textContent = "–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç";
    selectedSet.clear();
    clearEditor();
    render();
  }

  function download(){
    const base = loadedFileName || "playlist.m3u8";
    const filename = base.replace(/\.m3u$/i,".m3u8");
    downloadText(filename, toM3U8(entries));
  }

  // --- Clean mode UI helpers
  function setChip(el, on){
    el.classList.toggle("on", !!on);
  }

  function toggleSet(set, key){
    if(set.has(key)) set.delete(key);
    else set.add(key);
  }

  function refreshChips(){
    els.qChips.querySelectorAll(".chip").forEach(ch=> setChip(ch, clean.q.has(ch.dataset.q)));
    els.fieldChips.querySelectorAll(".chip").forEach(ch=> setChip(ch, clean.fields.has(ch.dataset.f)));
    els.junkChips.querySelectorAll(".chip").forEach(ch=> setChip(ch, clean.junk.has(ch.dataset.j)));
    els.sortMode.value = clean.sort;
  }

  function openSheet(){
    refreshChips();
    els.sheet.classList.add("open");
  }
  function closeSheet(){
    els.sheet.classList.remove("open");
  }

  function setCleanMode(on){
    cleanMode = !!on;
    els.btnCleanMode.textContent = cleanMode ? "üßπ –†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏: –≤–∫–ª" : "üßπ –†–µ–∂–∏–º —á–∏—Å—Ç–∫–∏: –≤—ã–∫–ª";
    if(!cleanMode){
      closeSheet();
      selectedSet.clear();
    } else {
      openSheet();
    }
    render();
  }

  function selectAllVisible(){
    const view = viewEntries();
    for(const e of view) selectedSet.add(e.id);
    render();
  }

  function clearSelection(){
    selectedSet.clear();
    render();
  }

  function bulkDelete(){
    const ids = new Set(selectedSet);
    if(ids.size === 0) return;

    const view = viewEntries();
    const visibleIds = new Set(view.map(e=>e.id));
    const toDelete = [...ids].filter(id => visibleIds.has(id));
    if(toDelete.length === 0) {
      alert("–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å: –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º –æ—Ç–æ–±—Ä–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ.");
      return;
    }

    const ok = confirm(`–£–¥–∞–ª–∏—Ç—å ${toDelete.length} –∫–∞–Ω–∞–ª(–æ–≤) –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–±–æ—Ä–∞?`);
    if(!ok) return;

    lastDeletedSnapshot = entries.map(e => ({...e, attrs: {...(e.attrs||{})}}));

    const delSet = new Set(toDelete);
    entries = entries.filter(e => !delSet.has(e.id));

    for(const id of toDelete) selectedSet.delete(id);
    if(selectedId && delSet.has(selectedId)) clearEditor();

    render();
  }

  function applySortFromSheet(){
    clean.sort = els.sortMode.value;
    closeSheet();
    render();
  }

  function clearCleanCriteria(){
    clean.q.clear();
    clean.fields.clear();
    clean.junk.clear();
    clean.sort = "none";
    refreshChips();
    render();
  }

  // --- events
  els.fileInput.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if(f) await loadFile(f);
    els.fileInput.value = "";
  });

  els.btnNew.onclick = newPlaylist;
  els.btnAdd.onclick = add;
  els.btnDeleteOne.onclick = delOne;
  els.btnApply.onclick = apply;
  els.btnRevert.onclick = revert;
  els.btnDownload.onclick = download;

  els.search.oninput = render;
  els.groupFilter.onchange = render;

  els.btnCleanMode.onclick = () => setCleanMode(!cleanMode);
  els.btnCloseSheet.onclick = closeSheet;

  els.qChips.addEventListener("click", (ev)=>{
    const chip = ev.target.closest(".chip");
    if(!chip) return;
    toggleSet(clean.q, chip.dataset.q);
    setChip(chip, clean.q.has(chip.dataset.q));
    render();
  });
  els.fieldChips.addEventListener("click", (ev)=>{
    const chip = ev.target.closest(".chip");
    if(!chip) return;
    toggleSet(clean.fields, chip.dataset.f);
    setChip(chip, clean.fields.has(chip.dataset.f));
    render();
  });
  els.junkChips.addEventListener("click", (ev)=>{
    const chip = ev.target.closest(".chip");
    if(!chip) return;
    toggleSet(clean.junk, chip.dataset.j);
    setChip(chip, clean.junk.has(chip.dataset.j));
    render();
  });

  els.btnApplySort.onclick = applySortFromSheet;
  els.btnClearClean.onclick = clearCleanCriteria;

  els.btnSelectAll.onclick = selectAllVisible;
  els.btnClearSel.onclick = clearSelection;
  els.btnBulkDelete.onclick = bulkDelete;

  if(els.btnToggleGroups){
    els.btnToggleGroups.onclick = () => {
      els.sidebar.classList.toggle("open");
    };
  }

  // init
  newPlaylist();
})();
</script>
</body>
</html>
